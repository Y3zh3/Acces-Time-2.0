// Esquema de base de datos para AccessTime - Sistema Biométrico

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Enumeración de Roles del Sistema
enum UserRole {
  ADMINISTRADOR    // Acceso completo al sistema
  SUPERVISOR       // Gestión de personal y reportes
  SEGURIDAD        // Control de accesos
}

// Usuarios del Sistema (Supervisores y Seguridad)
model SystemUser {
  id              Int       @id @default(autoincrement()) @map("id")
  username        String    @unique @db.VarChar(50) @map("usuario")
  password        String    @db.VarChar(255) @map("contrasena")
  fullName        String    @db.VarChar(255) @map("nombre_completo")
  role            String    @db.VarChar(50) @map("rol")
  email           String?   @db.VarChar(255) @map("email")
  status          String    @default("Activo") @db.VarChar(50) @map("estado")
  createdAt       DateTime  @default(now()) @map("creado_en")
  updatedAt       DateTime  @updatedAt @map("actualizado_en")
  
  @@map("usuarios_sistema")
}

// Tabla de Empleados con credenciales
model Employee {
  id              Int       @id @default(autoincrement()) @map("id")
  fullName        String    @db.VarChar(255) @map("nombre_completo")
  dni             String    @unique @db.VarChar(20) @map("dni")
  role            String    @default("EMPLEADO") @db.VarChar(50) @map("rol") // Tipo de personal: EMPLEADO, etc.
  position        String?   @db.VarChar(100) @map("cargo") // Cargo específico (Asistente, Operario, etc.)
  department      String    @db.VarChar(100) @map("departamento")
  location        String?   @db.VarChar(50) @map("sede") // Sede de trabajo (Lima, Ves, SJL)
  contractExpiry  DateTime? @map("vencimiento_contrato") // Fecha de vencimiento del contrato
  email           String?   @db.VarChar(255) @map("email")
  photoPath       String?   @db.VarChar(500) @map("ruta_foto")
  status          String    @default("Activo") @db.VarChar(50) @map("estado")
  hasBiometric    Boolean   @default(false) @map("tiene_biometrico")
  workStartTime   String?   @default("08:00") @db.VarChar(5) @map("hora_entrada") // Hora de inicio laboral (HH:mm)
  workEndTime     String?   @default("17:45") @db.VarChar(5) @map("hora_salida") // Hora de fin laboral (HH:mm)
  entryDateTime   DateTime? @map("fecha_hora_entrada") // Última entrada registrada
  exitDateTime    DateTime? @map("fecha_hora_salida") // Última salida registrada
  createdAt       DateTime  @default(now()) @map("creado_en")
  updatedAt       DateTime  @updatedAt @map("actualizado_en")
  
  // Relaciones
  biometric       FaceBiometric?
  accessLogs      AccessLog[]
  issuedPasses    TemporaryPass[] @relation("IssuedPasses")
  
  @@index([dni])
  @@index([status])
  @@map("empleados")
}

// Tabla de Datos Biométricos Faciales
model FaceBiometric {
  id                    Int       @id @default(autoincrement()) @map("id")
  employeeId            Int?      @unique @map("empleado_id")
  transportPersonnelId  Int?      @unique @map("personal_transporte_id")
  providerPersonnelId   Int?      @unique @map("personal_proveedor_id")
  descriptor            String    @db.Text @map("descriptor") // JSON array de 128 valores
  isActive              Boolean   @default(true) @map("activo")
  createdAt             DateTime  @default(now()) @map("creado_en")
  updatedAt             DateTime  @updatedAt @map("actualizado_en")
  
  // Relaciones
  employee              Employee?           @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  transportPersonnel    TransportPersonnel? @relation(fields: [transportPersonnelId], references: [id], onDelete: Cascade)
  providerPersonnel     ProviderPersonnel?  @relation(fields: [providerPersonnelId], references: [id], onDelete: Cascade)
  
  @@index([isActive])
  @@map("biometricos_faciales")
}

// Tabla de Personal de Transporte (proveedores externos)
model TransportPersonnel {
  id              Int       @id @default(autoincrement()) @map("id")
  fullName        String    @db.VarChar(255) @map("nombre_completo")
  dni             String    @unique @db.VarChar(20) @map("dni")
  company         String    @db.VarChar(255) @map("empresa")
  vehicle         String?   @db.VarChar(100) @map("vehiculo")
  licensePlate        String?   @db.VarChar(20) @map("matricula")
  photoPath           String?   @db.VarChar(500) @map("ruta_foto")
  status              String    @default("Activo") @db.VarChar(50) @map("estado")
  workStartTime       String?   @default("08:00") @db.VarChar(5) @map("hora_entrada") // Hora de inicio laboral (HH:mm)
  workEndTime         String?   @default("17:45") @db.VarChar(5) @map("hora_salida") // Hora de fin laboral (HH:mm)
  entryDateTime       DateTime? @map("fecha_hora_entrada_programada") // Fecha y hora de entrada PROGRAMADA
  exitDateTime        DateTime? @map("fecha_hora_salida_programada") // Fecha y hora de salida PROGRAMADA
  actualEntryDateTime DateTime? @map("fecha_hora_entrada_real") // Fecha y hora de entrada REAL
  actualExitDateTime  DateTime? @map("fecha_hora_salida_real") // Fecha y hora de salida REAL
  createdAt           DateTime  @default(now()) @map("creado_en")
  updatedAt           DateTime  @updatedAt @map("actualizado_en")
  
  // Relaciones
  biometric       FaceBiometric?
  accessLogs      AccessLog[]
  
  @@index([dni])
  @@index([exitDateTime])
  @@map("personal_transporte")
}

// Tabla de Empresas Proveedoras
model ProviderCompany {
  id                  Int       @id @default(autoincrement()) @map("id")
  companyName         String    @unique @db.VarChar(255) @map("nombre_empresa")
  ruc                 String?   @db.VarChar(50) @map("ruc")
  supplyType          String?   @db.VarChar(100) @map("tipo_suministro")
  commercialContact   String?   @db.VarChar(255) @map("contacto_comercial")
  phone               String?   @db.VarChar(50) @map("telefono")
  address             String?   @db.VarChar(500) @map("direccion")
  status              String    @default("Activo") @db.VarChar(50) @map("estado")
  createdAt           DateTime  @default(now()) @map("creado_en")
  updatedAt           DateTime  @updatedAt @map("actualizado_en")
  
  @@index([companyName])
  @@map("empresas_proveedoras")
}

// Tabla de Personal de Proveedores (empresas de suministros)
model ProviderPersonnel {
  id              Int       @id @default(autoincrement()) @map("id")
  fullName        String    @db.VarChar(255) @map("nombre_completo")
  dni             String    @unique @db.VarChar(20) @map("dni")
  company         String    @db.VarChar(255) @map("empresa")
  position        String?   @db.VarChar(100) @map("cargo")
  phone               String?   @db.VarChar(50) @map("telefono")
  photoPath           String?   @db.VarChar(500) @map("ruta_foto")
  status              String    @default("Activo") @db.VarChar(50) @map("estado")
  workStartTime       String?   @default("08:00") @db.VarChar(5) @map("hora_entrada") // Hora de inicio laboral (HH:mm)
  workEndTime         String?   @default("17:45") @db.VarChar(5) @map("hora_salida") // Hora de fin laboral (HH:mm)
  entryDateTime       DateTime? @map("fecha_hora_entrada_programada") // Fecha y hora de entrada PROGRAMADA
  exitDateTime        DateTime? @map("fecha_hora_salida_programada") // Fecha y hora de salida PROGRAMADA
  actualEntryDateTime DateTime? @map("fecha_hora_entrada_real") // Fecha y hora de entrada REAL
  actualExitDateTime  DateTime? @map("fecha_hora_salida_real") // Fecha y hora de salida REAL
  createdAt           DateTime  @default(now()) @map("creado_en")
  updatedAt           DateTime  @updatedAt @map("actualizado_en")
  
  // Relaciones
  biometric       FaceBiometric?
  accessLogs      AccessLog[]
  
  @@index([dni])
  @@index([exitDateTime])
  @@map("personal_proveedores")
}

// Tabla de Logs de Acceso
model AccessLog {
  id              Int       @id @default(autoincrement()) @map("id")
  userName        String    @db.VarChar(255) @map("nombre_usuario")
  userDni         String?   @db.VarChar(20) @map("dni_usuario")
  role            String    @db.VarChar(100) @map("rol")
  status          String    @db.VarChar(50) @map("estado") // Aprobado, Denegado, Fuera de Horario
  zone            String    @db.VarChar(100) @map("zona")
  type            String    @db.VarChar(50) @map("tipo") // success, warning, critical
  entryTime       DateTime  @default(now()) @map("hora_entrada") // Hora de entrada
  exitTime        DateTime? @map("hora_salida") // Hora de salida (null hasta que salga)
  
  // Relaciones opcionales
  employeeId      Int? @map("empleado_id")
  transportId     Int? @map("transporte_id")
  providerId      Int? @map("proveedor_id")
  
  employee        Employee?           @relation(fields: [employeeId], references: [id], onDelete: SetNull)
  transport       TransportPersonnel? @relation(fields: [transportId], references: [id], onDelete: SetNull)
  provider        ProviderPersonnel?  @relation(fields: [providerId], references: [id], onDelete: SetNull)
  
  @@index([entryTime])
  @@index([userDni])
  @@index([status])
  @@index([type])
  @@map("registros_acceso")
}

// Tabla de Pases Temporales
model TemporaryPass {
  id              Int       @id @default(autoincrement()) @map("id")
  fullName        String    @db.VarChar(255) @map("nombre_completo")
  dni             String    @db.VarChar(20) @map("dni")
  company         String?   @db.VarChar(255) @map("empresa")
  reason          String    @db.Text @map("motivo")
  authorizedBy    String    @db.VarChar(255) @map("autorizado_por") // Nombre del supervisor
  issuedById      Int?      @map("emitido_por_id") // ID del empleado que emitió el pase
  validFrom       DateTime  @map("valido_desde")
  validUntil      DateTime  @map("valido_hasta")
  status          String    @default("Activo") @db.VarChar(50) @map("estado")
  createdAt       DateTime  @default(now()) @map("creado_en")
  
  // Relación con el empleado que emitió el pase
  issuedBy        Employee? @relation("IssuedPasses", fields: [issuedById], references: [id], onDelete: SetNull)
  
  @@index([validFrom, validUntil])
  @@index([status])
  @@map("pases_temporales")
}
